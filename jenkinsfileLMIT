#!/usr/bin/env groovy
@Library(['piper-lib', 'piper-lib-os','lmit-jenkins-lib']) _

def checkacc() {
	
	withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:env.BTPCredentialID,usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]){	  
				  sh '''
				  echo "************ Check if Subaccount exists *********************************"
				  echo "************************************************************************** " 
					   pip3 install -r requirements.txt
					   cd scripts
					   python3 installations.py
					   python3 subaccount_exists.py  
				 '''
				is_account_exists = readFile(file: 'myfile.txt')
				print(is_account_exists)	
				return is_account_exists
	}
	
}

node ('windowskymanode') 
{

dockerExecuteOnKubernetes(script: this, dockerEnvVars: ['pusername':pusername, 'puserpwd':puserpwd], dockerImage: 'docker.wdf.sap.corp:51010/sfext:v3-py' )
{
try {



		stage ('Git-clone') 
			{
				deleteDir()
                checkout scm
				withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:'GithubTools',usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]){
				sh'''
				git clone https://github.com/VanitaDhanagar/kyma-multitenant-extension.git --branch 'main'
				mv ./kyma-multitenant-extension/* ./
				git clone https://$USERNAME:$PASSWORD@github.tools.sap/btp-ppu-test/ReusableActions.git --branch 'master'
				mv ./ReusableActions/* ./
                git clone https://github.com/SAP-samples/btp-kyma-multitenant-extension.git --branch 'main'
				mv ./btp-kyma-multitenant-extension/* ./
				'''
				

				}

			}
			stage ('check_Subaccount_exist') 
			{
				withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:env.BTPCredentialID,usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]){
           
				    writeJSON file: 'manifest.json', json: params.ManifestJsonFileContent
							data1 = readJSON file:'manifest.json'
							print(data1) 
				    sh '''
				    mv manifest.json ./config/
					env
				    '''
				    is_account_exists = checkacc()
				    print(is_account_exists)	

				    if (is_account_exists == 'True') {

					print("Subaccount already exists.")

						
				     }

				}
				  
			}
			stage('Application deployment')
	{
	withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:'GithubTools',usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']])
              {
	withKubeConfig([credentialsId: 'kubeconfiglmit']) 
{
           
 
                        sh '''		  
                        kubectl config view 	
                        ./btpsa-deployment.sh
                        '''   
						 sleep 100;
              
          }
		  
			  }
	   
	   
		 }
		stage('Subscribe Application')
		 {
		// 	   withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:env.BTPCredentialID,usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]){
		// 		try{
        //           subscribeToSaaS(
        //             script: this,
        //             btpCredentialsId: env.BTPCredentialID,
        //             btpGlobalAccountId: '2a979d83-c576-4ff8-a281-8bb45bc5480d',
        //             saasApplicationName: 'easyfranchise-kymacrossconsumption-e530d087',
		// 			btpLandscape: 'canary',
        //             btpRegion: 'eu10-canary',
        //             saasSubscribtionPlan: 'default',
        //             btpSubdomainName: 'cityscooter-bzxa8vyuws'
        //           )
        //         }
        //         catch(Exception e){
        //           sleep 60;
        //         }


		// }
		}
		stage('UI_Test_Execution')
		{
		// 	withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:env.BTPCredentialID,usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]){		
		// 	    data = readJSON file: './config/manifest.json'		  
		// 		paramSub = "${data.subaccounts[0].display_name}"
		// 		print paramSub
		// 		landscapeUrl = "${data.global_logon.landscape_url}"			
		// 		print landscapeUrl
		// 		orgname = "${data.subaccounts[0].org_name}"
		// 		print orgname
		// 		spacename = "${data.subaccounts[0].space_name}"
		// 		print spacename
		// 		username = env.username
		// 		print username
		// 		password = env.password
		// 		print password
		// 		build job: 'Kyma_Multitenant_LMIT_UI_Canary_Mock', parameters: [[$class: 'StringParameterValue', name: 'URL', value: landscapeUrl],[$class: 'StringParameterValue', name: 'Username', value: username],[$class: 'StringParameterValue', name: 'Password', value: password],[$class: 'StringParameterValue', name: 'Subaccount', value: paramSub]]

		// }
		}
		stage('Unsubscribe Application')
		{	

        //   withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:env.BTPCredentialID,usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]){
		// 		try{
        //           unsubscribeFromSaaS(
        //             script: this,
        //             btpCredentialsId: env.BTPCredentialID,
        //             btpGlobalAccountId: '2a979d83-c576-4ff8-a281-8bb45bc5480d',
        //             saasApplicationName: 'easyfranchise-kymacrossconsumption-e530d087',
		// 			btpLandscape: 'canary',
        //             btpRegion: 'eu10-canary',
        //             saasSubscribtionPlan: "",
        //             btpSubdomainName: 'cityscooter-bzxa8vyuws'
        //           )
        //         }
        //         catch(Exception e){
        //           sleep 60;
        //         }


		// }
		}
				stage('Undeploy Apps')
	{
//         node ('windowskymanode') 
// {
//     deleteDir()

//               withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId:'GithubTools',usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']])
//               {

//          withKubeConfig([credentialsId: 'kubeconfiglmit']) 
// {
// 	          //build job: 'Login_to_KymaDashboard'
			
//                         sh '''
//                         git clone https://github.com/VanitaDhanagar/kyma-multitenant-extension.git --branch 'main'
// 				mv ./kyma-multitenant-extension/* ./
// 				git clone https://github.com/SAP-samples/btp-kyma-multitenant-extension.git --branch 'main'
// 				mv ./btp-kyma-multitenant-extension/* ./
//                           kubectl version
// 						   sleep 1m
//                           kubectl config view
//                           pwd
// 						  chmod +x ./kyma-un-deployment.sh
// 						  ./kyma-un-deployment.sh

//                         '''   
              
          
// }
// }  
// }
          
		 }	

		}
				 
	catch(e){
		echo e.toString()
		echo 'This will run only if failed'
		currentBuild.result = "FAILURE"
	}
	finally {
		emailext body: '$DEFAULT_CONTENT', subject: '$DEFAULT_SUBJECT', to: 'vanita.dhanagar@sap.com'
	}
}
} 


